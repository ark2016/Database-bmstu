Мы рассмотрим как данные, извлечённые из таблицы `Region`, так и информацию о блокировках, полученную с помощью представления `sys.dm_tran_locks`. Это поможет понять, как различные уровни изоляции транзакций влияют на доступ к данным и управление блокировками в MS SQL Server.

### Общие понятия

1. **Таблица `Region`**: Содержит записи регионов с полями `region_id` и `name`.
2. **`sys.dm_tran_locks`**: Динамическое представление, отображающее текущие блокировки в системе. Поля:
   - `resource_type`: Тип ресурса (DATABASE, OBJECT, PAGE, KEY и т.д.).
   - `resource_subtype`: Подтип ресурса (например, RangeS-S, RangeX-X).
   - `request_mode`: Режим блокировки (S - Shared, X - Exclusive и другие).

### Анализ Выводов

Мы будем рассматривать пары вывода: сначала данные из таблицы `Region`, затем информация о блокировках. Предположим, что выводы представлены в порядке выполнения примеров из скрипта (1-12).

#### Пример 1: Read Uncommitted - Грязное чтение (Возможно)

**Данные из `Region`:**
```
1	Санкт-Петербург
```
**Блокировки:**
```
DATABASE		S
PAGE		IX
KEY		X
OBJECT		IX
```

**Объяснение:**

- **Данные**: Сессия 2 (установившая уровень изоляции `READ UNCOMMITTED`) прочитала обновлённое значение `name` ('Санкт-Петербург') из строки с `region_id = 1`, несмотря на то, что транзакция в Сессии 1 не была зафиксирована. Это демонстрирует **грязное чтение**, когда одна транзакция может видеть незавершенные изменения другой транзакции.

- **Блокировки**:
  - `DATABASE S`: Общая блокировка на уровне базы данных, указывающая на чтение данных.
  - `OBJECT IX`: Намеренная эксклюзивная блокировка на уровне объекта (таблицы), свидетельствующая о намерении изменить данные.
  - `PAGE IX`: Намеренная эксклюзивная блокировка на уровне страницы.
  - `KEY X`: Эксклюзивная блокировка на уровне ключа (строки), предотвращающая другие транзакции от изменения этой строки.

**Вывод**: При уровне изоляции `READ UNCOMMITTED` возможно грязное чтение, поскольку блокировки не предотвращают чтение незавершённых изменений.

---

#### Пример 2: Read Uncommitted - Невоспроизводимое чтение (Возможно)

**Данные из `Region` до обновления:**
```
1	Москва
```
**Данные из `Region` после обновления:**
```
1	Санкт-Петербург
```
**Блокировки:**
```
DATABASE		S
PAGE		IX
KEY		X
OBJECT		IX
```

**Объяснение:**

- **Данные**:
  - **До обновления**: Сессия 1 читает значение 'Москва'.
  - **После обновления**: После выполнения обновления в Сессии 2, Сессия 1 снова читает строку и получает обновлённое значение 'Санкт-Петербург'.
  - Это демонстрирует **невоспроизводимое чтение**, когда повторный запрос в рамках одной транзакции возвращает разные результаты из-за изменений, внесённых другой транзакцией.

- **Блокировки**:
  - Аналогично Примеру 1, блокировки позволяют видеть изменения другой транзакции.

**Вывод**: Уровень изоляции `READ UNCOMMITTED` допускает невоспроизводимые чтения, так как не обеспечивает стабильность данных между запросами в одной транзакции.

---

#### Пример 3: Read Uncommitted - Фантомное чтение (Возможно)

**Данные из `Region` до вставки:**
```
1	Санкт-Петербург
```
**Данные из `Region` после вставки:**
```
1	Санкт-Петербург
2	Магадан
```
**Блокировки:**
```
DATABASE		S
OBJECT		IX
PAGE		IX
KEY		X
OBJECT		IX
```

**Объяснение:**

- **Данные**:
  - **До вставки**: Сессия 1 видит одну строку.
  - **После вставки**: Вторая транзакция вставляет новую строку ('Магадан'), и Сессия 1 уже видит две строки.
  - Это демонстрирует **фантомное чтение**, когда новая строка появляется в результате другой транзакции.

- **Блокировки**:
  - Блокировки типа `IX` и `X` позволяют другой транзакции вставлять новые строки, поскольку `READ UNCOMMITTED` не накладывает строгих ограничений на диапазоны данных.

**Вывод**: Уровень изоляции `READ UNCOMMITTED` допускает фантомные чтения, поскольку не предотвращает вставку новых строк в диапазон данных, читаемый транзакцией.

---

#### Пример 4: Read Committed - Грязное чтение (Невозможно)

**Данные из `Region`:**
```
1	Санкт-Петербург
```
**Блокировки:**
```
DATABASE		S
PAGE		IX
KEY		X
OBJECT		IX
```

**Объяснение:**

- **Данные**: Сессия 2 (установившая уровень изоляции `READ COMMITTED`) пытается прочитать данные, но не видит незавершённые изменения из Сессии 1. Поэтому она не может прочитать 'Санкт-Петербург' до фиксации транзакции в Сессии 1.

- **Блокировки**:
  - `DATABASE S`, `OBJECT IX`, `PAGE IX`, `KEY X`: Эти блокировки предотвращают чтение или изменение данных до завершения транзакции, обеспечивая, что только зафиксированные данные доступны другим транзакциям.

**Вывод**: Уровень изоляции `READ COMMITTED` предотвращает грязные чтения, гарантируя, что транзакции видят только зафиксированные данные.

---

#### Пример 5: Read Committed - Невоспроизводимое чтение (Возможно)

**Данные из `Region` до обновления:**
```
1	Москва
```
**Данные из `Region` после обновления:**
```
1	Санкт-Петербург
```
**Блокировки:**
```
DATABASE		S
PAGE		IX
KEY		X
OBJECT		IX
```

**Объяснение:**

- **Данные**:
  - **До обновления**: Сессия 1 читает 'Москва'.
  - **После обновления**: Сессия 2 обновляет значение на 'Санкт-Петербург', и при повторном чтении Сессия 1 видит новое значение.
  - Это демонстрирует **невоспроизводимое чтение**, когда данные изменяются другой транзакцией между двумя запросами в одной транзакции.

- **Блокировки**:
  - Несмотря на уровень изоляции `READ COMMITTED`, блокировки не предотвращают изменения данных между запросами, что позволяет видеть обновления других транзакций.

**Вывод**: Уровень изоляции `READ COMMITTED` допускает невоспроизводимые чтения, поскольку каждый запрос внутри транзакции видит актуальные зафиксированные данные на момент выполнения запроса.

---

#### Пример 6: Read Committed - Фантомное чтение (Возможно)

**Данные из `Region` до вставки:**
```
1	Санкт-Петербург
```
**Данные из `Region` после вставки:**
```
1	Санкт-Петербург
2	Магадан
```
**Блокировки:**
```
DATABASE		S
PAGE		IX
KEY		X
OBJECT		IX
```

**Объяснение:**

- **Данные**:
  - **До вставки**: Сессия 1 видит одну строку.
  - **После вставки**: Сессия 2 вставляет новую строку ('Магадан'), и Сессия 1 видит обе строки.
  - Это демонстрирует **фантомное чтение**, когда другая транзакция вставляет новые строки в диапазон данных, который читается транзакцией.

- **Блокировки**:
  - Блокировки позволяют другим транзакциям вставлять новые строки, поскольку `READ COMMITTED` не накладывает ограничений на диапазоны данных, предотвращающих фантомные вставки.

**Вывод**: Уровень изоляции `READ COMMITTED` допускает фантомные чтения, позволяя вставку новых строк другими транзакциями.

---

#### Пример 7: Repeatable Read - Грязное чтение (Невозможно)

**Данные из `Region`:**
```
1	Санкт-Петербург
```
**Блокировки:**
```
DATABASE		S
PAGE		IX
KEY		X
OBJECT		IX
```

**Объяснение:**

- **Данные**: Сессия 2 (установившая уровень изоляции `REPEATABLE READ`) пытается прочитать данные, но не видит незавершённые изменения из Сессии 1. Это предотвращает грязные чтения.

- **Блокировки**:
  - `DATABASE S`, `OBJECT IX`, `PAGE IX`, `KEY X`: Эти блокировки обеспечивают стабильность данных, удерживая блокировки до завершения транзакции и предотвращая другие транзакции от изменения данных.

**Вывод**: Уровень изоляции `REPEATABLE READ` предотвращает грязные чтения, обеспечивая, что транзакции видят только зафиксированные данные.

---

#### Пример 8: Repeatable Read - Невоспроизводимое чтение (Невозможно)

**Данные из `Region` до обновления:**
```
1	Москва
```
**Данные из `Region` после обновления:**
```
1	Москва
```
**Блокировки:**
```
DATABASE		S
PAGE		IX
KEY		X
OBJECT		IX
```

**Объяснение:**

- **Данные**:
  - **До обновления**: Сессия 1 читает 'Москва'.
  - **После обновления**: Сессия 2 обновляет значение на 'Санкт-Петербург', но из-за уровня изоляции `REPEATABLE READ` Сессия 1 продолжает видеть 'Москва' при повторном чтении.
  - Это демонстрирует отсутствие **невоспроизводимого чтения**, поскольку блокировки предотвращают изменение данных другими транзакциями до завершения текущей транзакции.

- **Блокировки**:
  - `REPEATABLE READ` удерживает **shared** блокировки на прочитанных строках до завершения транзакции, предотвращая изменения данных другими транзакциями.

**Вывод**: Уровень изоляции `REPEATABLE READ` предотвращает невоспроизводимые чтения, гарантируя, что данные остаются неизменными в течение всей транзакции.

---

#### Пример 9: Repeatable Read - Фантомное чтение (Возможно)

**Данные из `Region` до вставки:**
```
1	Санкт-Петербург
```
**Данные из `Region` после вставки:**
```
1	Санкт-Петербург
2	Магадан
```
**Блокировки:**
```
DATABASE		S
PAGE		IX
KEY		X
OBJECT		IX
```

**Объяснение:**

- **Данные**:
  - **До вставки**: Сессия 1 видит одну строку.
  - **После вставки**: Сессия 2 вставляет новую строку ('Магадан'), и Сессия 1 видит две строки.
  - Это демонстрирует **фантомное чтение**, когда другая транзакция вставляет новую строку в диапазон данных, который читается текущей транзакцией.

- **Блокировки**:
  - Уровень изоляции `REPEATABLE READ` предотвращает изменения существующих строк, но не защищает от вставки новых строк. Поэтому фантомные вставки всё ещё возможны.

**Вывод**: Уровень изоляции `REPEATABLE READ` предотвращает изменения существующих данных, но допускает фантомные чтения, позволяя вставку новых строк другими транзакциями.

---

#### Пример 10: Serializable - Грязное чтение (Невозможно)

**Данные из `Region`:**
```
1	Санкт-Петербург
```
**Блокировки:**
```
DATABASE		S
PAGE		IX
KEY		X
OBJECT		IX
```

**Объяснение:**

- **Данные**: Сессия 2 (установившая уровень изоляции `SERIALIZABLE`) пытается прочитать данные, но не видит незавершённые изменения из Сессии 1. Это предотвращает грязные чтения.

- **Блокировки**:
  - `SERIALIZABLE` накладывает самые строгие блокировки, включая `RangeS-S` и `RangeX-X`, предотвращающие любые изменения или вставки в диапазон данных, читаемых транзакцией.

**Вывод**: Уровень изоляции `SERIALIZABLE` предотвращает грязные чтения, обеспечивая максимальную изоляцию транзакций.

---

#### Пример 11: Serializable - Невоспроизводимое чтение (Невозможно)

**Данные из `Region` до обновления:**
```
1	Москва
```
**Данные из `Region` после обновления:**
```
1	Москва
```
**Блокировки:**
```
DATABASE		S
PAGE		IX
KEY		X
OBJECT		IX
```

**Объяснение:**

- **Данные**:
  - **До обновления**: Сессия 1 читает 'Москва'.
  - **После обновления**: Сессия 2 обновляет значение на 'Санкт-Петербург', но из-за уровня изоляции `SERIALIZABLE` Сессия 1 продолжает видеть 'Москва'.
  - Это демонстрирует отсутствие **невоспроизводимого чтения**, поскольку блокировки предотвращают изменения данных другими транзакциями.

- **Блокировки**:
  - `SERIALIZABLE` удерживает блокировки на диапазоне данных, предотвращая любые изменения и вставки в этот диапазон до завершения транзакции.

**Вывод**: Уровень изоляции `SERIALIZABLE` предотвращает невоспроизводимые чтения, обеспечивая, что данные остаются неизменными в течение всей транзакции.

---

#### Пример 12: Serializable - Фантомное чтение (Невозможно)

**Данные из `Region` до вставки:**
```
1	Санкт-Петербург
```
**Данные из `Region` после вставки:**
```
1	Санкт-Петербург
2	Магадан
```
**Блокировки:**
```
DATABASE		S
PAGE		IX
KEY		RangeS-S
KEY		RangeS-S
KEY		RangeS-S
KEY		RangeX-X
KEY		RangeS-S
OBJECT		IX
```

**Объяснение:**

- **Данные**:
  - **До вставки**: Сессия 1 видит одну строку.
  - **После вставки**: Сессия 2 вставляет новую строку ('Магадан'), но Сессия 1 не видит эту строку из-за уровня изоляции `SERIALIZABLE`.
  - Это демонстрирует отсутствие **фантомного чтения**, поскольку блокировки предотвращают вставку новых строк в диапазон данных, читаемых транзакцией.

- **Блокировки**:
  - `RangeS-S`: Диапазонные блокировки, предотвращающие вставку новых строк в диапазон данных, читаемых транзакцией.
  - `RangeX-X`: Эксклюзивные блокировки на диапазоне и ключе.
  - Эти блокировки обеспечивают, что никакие новые строки не могут быть вставлены или изменены в пределах диапазона данных до завершения транзакции.

**Вывод**: Уровень изоляции `SERIALIZABLE` предотвращает фантомные чтения, обеспечивая, что диапазон данных остаётся неизменным и без новых вставок в течение всей транзакции.

---

#### Пример 13: Исследование блокировок с использованием `sys.dm_tran_locks`

**Данные из `Region`:**
```
1	Санкт-Петербург
2	Магадан
3	Магадан
4	Магадан
5	Магадан
```
**Блокировки:**
```
DATABASE		S
PAGE		IX
KEY		RangeS-S
KEY		RangeS-S
KEY		RangeS-S
KEY		RangeS-S
KEY		RangeX-X
KEY		RangeS-S
OBJECT		IX
```

**Объяснение:**

- **Данные**: На момент выполнения запроса блокировок Сессия 2 установила несколько диапазонных блокировок (`RangeS-S` и `RangeX-X`), что указывает на строгий контроль над диапазоном данных.

- **Блокировки**:
  - `RangeS-S`: Shared Range Locks, предотвращающие вставку новых строк в диапазон данных.
  - `RangeX-X`: Exclusive Range Locks, блокирующие любые изменения в диапазоне данных.
  - Эти блокировки являются характерными для уровня изоляции `SERIALIZABLE`, обеспечивая полную изоляцию транзакций.

**Вывод**: Уровень изоляции `SERIALIZABLE` накладывает строгие диапазонные блокировки, предотвращая любые изменения или вставки в диапазон данных, читаемых транзакцией.

---

### Заключение

Каждый уровень изоляции транзакций в MS SQL Server влияет на поведение блокировок и доступ к данным различными транзакциями:

1. **READ UNCOMMITTED**:
   - **Грязные чтения**: Возможны.
   - **Невоспроизводимые чтения и фантомные чтения**: Возможны.
   - **Блокировки**: Минимальные, позволяющие максимально параллельную работу, но с риском неконсистентных данных.

2. **READ COMMITTED**:
   - **Грязные чтения**: Недопустимы.
   - **Невоспроизводимые чтения и фантомные чтения**: Возможны.
   - **Блокировки**: Shared блокировки удерживаются на время выполнения запроса, предотвращая чтение незавершённых транзакций.

3. **REPEATABLE READ**:
   - **Грязные чтения**: Недопустимы.
   - **Невоспроизводимые чтения**: Недопустимы.
   - **Фантомные чтения**: Возможны.
   - **Блокировки**: Shared блокировки удерживаются до завершения транзакции, предотвращая изменения прочитанных данных.

4. **SERIALIZABLE**:
   - **Грязные чтения**: Недопустимы.
   - **Невоспроизводимые чтения**: Недопустимы.
   - **Фантомные чтения**: Недопустимы.
   - **Блокировки**: Диапазонные блокировки предотвращают любые вставки или изменения в диапазоне данных, читаемых транзакцией.

Понимание этих механизмов позволяет эффективно управлять транзакциями и обеспечивать необходимый уровень согласованности данных в различных сценариях работы с базой данных.
